/**
 * File: variation-details.js
 * Description: Manages day selection and dynamic price updates for camps, and pro-rated pricing for courses on WooCommerce product pages. Player selection is handled server-side in elementor-widgets.php.
 * Dependencies: jQuery
 *
 * Testing:
 * - Select Single Day(s) camp (ID 29975), verify custom price container shows "Base Price: CHF 60.00 per day, Total: CHF 180.00 for 3 days" below default price.
 * - Select a course mid-term (ID 25295, variation ID 28965), confirm custom price container shows "Base Price: CHF 480.00, Discounted: CHF 320.00, You saved CHF 160.00" for 10 weeks remaining at 32 CHF/week, cart shows "Discount: 10 Weeks remaining".
 * - Test console logs show correct form data (e.g., "Days: []" for courses).
 */

jQuery(document).ready(function ($) {
  if (!intersoccerCheckout || !intersoccerCheckout.ajax_url) {
    console.error("InterSoccer: intersoccerCheckout not initialized.");
    return;
  }

  const translations = window.intersoccerTranslations || {
    select_days: "Select days",
  };

  // Refresh nonce if needed
  function refreshNonce() {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: intersoccerCheckout.nonce_refresh_url,
        type: "POST",
        data: { action: "intersoccer_refresh_nonce" },
        success: function (response) {
          if (response.success && response.data.nonce) {
            intersoccerCheckout.nonce = response.data.nonce;
            console.log(
              "InterSoccer: Nonce refreshed:",
              intersoccerCheckout.nonce
            );
            resolve();
          } else {
            console.error("InterSoccer: Nonce refresh failed:", response);
            reject(new Error("Nonce refresh failed"));
          }
        },
        error: function (xhr) {
          console.error(
            "InterSoccer: Nonce refresh error:",
            xhr.status,
            xhr.responseText
          );
          reject(new Error("Nonce refresh error: " + xhr.statusText));
        },
      });
    });
  }

  function fetchDaysOfWeek(productId, variationId) {
    return new Promise((resolve, reject) => {
      console.log(
        "InterSoccer: Fetching days for product ID:",
        productId,
        "variation ID:",
        variationId
      );
      $.ajax({
        url: intersoccerCheckout.ajax_url,
        type: "POST",
        data: {
          action: "intersoccer_get_days_of_week",
          nonce: intersoccerCheckout.nonce,
          product_id: productId,
          variation_id: variationId,
        },
        success: function (response) {
          console.log(
            "InterSoccer: intersoccer_get_days_of_week response:",
            response
          );
          if (
            response.success &&
            response.data.days &&
            Array.isArray(response.data.days)
          ) {
            console.log("InterSoccer: Days fetched:", response.data.days);
            resolve(response.data.days);
          } else {
            console.error(
              "InterSoccer: No days found in response:",
              response.data.message || "Unknown error"
            );
            reject(
              new Error(response.data.message || "No days found in response")
            );
          }
        },
        error: function (xhr) {
          console.error(
            "InterSoccer: AJAX error fetching days:",
            xhr.status,
            xhr.responseText
          );
          if (xhr.status === 403) {
            refreshNonce()
              .then(() => fetchDaysOfWeek(productId, variationId))
              .then(resolve)
              .catch(reject);
          } else {
            reject(new Error("Failed to fetch days: " + xhr.statusText));
          }
        },
      });
    });
  }

  function calculateProRatedPrice(
    basePrice,
    startDate,
    totalWeeks,
    weeklyDiscount
  ) {
    const serverTime = new Date(intersoccerCheckout.server_time || new Date());
    let start;

    // Try multiple date formats
    const formats = ["YYYY-MM-DD", "DD/MM/YYYY", "MM-DD-YYYY"];
    for (const format of formats) {
      if (format === "YYYY-MM-DD") {
        start = new Date(startDate);
      } else if (format === "DD/MM/YYYY") {
        const [day, month, year] = startDate.split("/");
        start = new Date(`${year}-${month}-${day}`);
      } else if (format === "MM-DD-YYYY") {
        const [month, day, year] = startDate.split("-");
        start = new Date(`${year}-${month}-${day}`);
      }
      if (start && !isNaN(start.getTime())) {
        break;
      }
    }

    if (!start || isNaN(start.getTime())) {
      console.error("InterSoccer: Invalid start date:", startDate);
      return { price: basePrice, remainingWeeks: totalWeeks };
    }

    const weeksPassed = Math.floor(
      (serverTime - start) / (7 * 24 * 60 * 60 * 1000)
    );
    const remainingWeeks = Math.max(0, totalWeeks - weeksPassed);
    let discountedPrice = remainingWeeks * weeklyDiscount;
    // Cap discounted price at base price
    discountedPrice = Math.min(discountedPrice, basePrice);

    console.log(
      "InterSoccer: Pro-rated price - Base:",
      basePrice,
      "Start:",
      startDate,
      "Weeks passed:",
      weeksPassed,
      "Remaining:",
      remainingWeeks,
      "Weekly discount:",
      weeklyDiscount,
      "Discounted price:",
      discountedPrice
    );
    return { price: Math.max(0, discountedPrice.toFixed(2)), remainingWeeks };
  }

  function fetchCourseMetadata(productId, variationId) {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: intersoccerCheckout.ajax_url,
        type: "POST",
        data: {
          action: "intersoccer_get_course_metadata",
          nonce: intersoccerCheckout.nonce,
          product_id: productId,
          variation_id: variationId,
        },
        success: function (response) {
          if (response.success && response.data) {
            console.log("InterSoccer: Course metadata:", response.data);
            resolve({
              start_date: response.data.start_date || "2025-01-01",
              total_weeks: parseInt(response.data.total_weeks, 10) || 1,
              weekly_discount: parseFloat(response.data.weekly_discount) || 0,
            });
          } else {
            console.error(
              "InterSoccer: No metadata in response:",
              response.data.message
            );
            reject(new Error(response.data.message || "No metadata found"));
          }
        },
        error: function (xhr) {
          console.error(
            "InterSoccer: AJAX error fetching metadata:",
            xhr.status,
            xhr.responseText
          );
          if (xhr.status === 403) {
            refreshNonce()
              .then(() => fetchCourseMetadata(productId, variationId))
              .then(resolve)
              .catch(reject);
          } else {
            reject(new Error("Failed to fetch metadata: " + xhr.statusText));
          }
        },
      });
    });
  }

  const $form = $("form.cart");
  if (!$form.length) {
    console.error("InterSoccer: Product form not found on page");
    return;
  }

  const productId = $form.data("product_id") || "unknown";
  let productType = "unknown";
  function fetchProductType() {
    $.ajax({
      url: intersoccerCheckout.ajax_url,
      type: "POST",
      data: {
        action: "intersoccer_get_product_type",
        nonce: intersoccerCheckout.nonce,
        product_id: productId,
      },
      success: function (response) {
        if (response.success && response.data.product_type) {
          productType = response.data.product_type;
          console.log("InterSoccer: Product type:", productType);
        }
      },
      error: function (xhr) {
        console.error(
          "InterSoccer: Failed to fetch product type:",
          xhr.status,
          xhr.responseText
        );
        if (xhr.status === 403) {
          refreshNonce().then(fetchProductType);
        }
      },
    });
  }
  fetchProductType();

  let selectedDays = [];
  let isProcessing = false;
  let availableDays = [];
  let currentVariationId = null;
  let isCheckboxUpdate = false;

  // Add inline CSS for custom price container
  $form.append(`
    <style>
      .intersoccer-custom-price .total-price{
        margin-top: 10px;
        font-size: 0.9em;
        color: #eec432;
      }
      .intersoccer-custom-price .savings {
        color: #27ae60;
        margin-left: 10px;
      }
    </style>
  `);

  function updateFormData(playerId, days, price, remainingWeeks = null) {
    $form.find('input[name="player_assignment"]').remove();
    $form.find('input[name="camp_days[]"]').remove();
    $form.find('input[name="adjusted_price"]').remove();
    $form.find('input[name="remaining_weeks"]').remove();

    if (playerId) {
      $form.append(
        `<input type="hidden" name="player_assignment" value="${playerId}">`
      );
    }
    if (days && days.length) {
      days.forEach((day) => {
        $form.append(`<input type="hidden" name="camp_days[]" value="${day}">`);
      });
    }
    if (price) {
      $form.append(
        `<input type="hidden" name="adjusted_price" value="${price}">`
      );
    }
    if (remainingWeeks !== null) {
      $form.append(
        `<input type="hidden" name="remaining_weeks" value="${remainingWeeks}">`
      );
    }
    console.log(
      "InterSoccer: Updated form data - Player:",
      playerId,
      "Days:",
      days,
      "Price:",
      price,
      "Remaining weeks:",
      remainingWeeks
    );
  }

  function renderCheckboxes(
    days,
    $dayCheckboxes,
    $dayNotification,
    $errorMessage,
    variationPrice,
    playerId,
    variationId
  ) {
    if (
      currentVariationId !== variationId ||
      $dayCheckboxes.find('input[type="checkbox"]').length === 0
    ) {
      console.log(
        "InterSoccer: Rendering checkboxes for variation:",
        variationId
      );
      $dayCheckboxes.empty();
      $dayNotification.empty();
      $errorMessage.hide();
      days.forEach((day) => {
        const isChecked = selectedDays.includes(day) ? "checked" : "";
        $dayCheckboxes.append(`
          <label>
            <input type="checkbox" name="camp_days[]" value="${day}" ${isChecked}> ${day}
          </label>
        `);
      });
    } else {
      console.log(
        "InterSoccer: Skipping checkbox re-render, same variation:",
        variationId
      );
    }

    $dayCheckboxes
      .find('input[type="checkbox"]')
      .off("change")
      .on("change", function (e) {
        e.stopPropagation();
        if (isProcessing) return;
        isProcessing = true;
        isCheckboxUpdate = true;

        selectedDays = $dayCheckboxes
          .find('input[type="checkbox"]:checked')
          .map(function () {
            return $(this).val();
          })
          .get();

        const quantity = 1;
        const totalPrice = selectedDays.length * variationPrice;

        clearTimeout(window.intersoccerUpdateTimeout);
        window.intersoccerUpdateTimeout = setTimeout(() => {
          $form.find('input[name="quantity"]').val(quantity);
          updateFormData(playerId, selectedDays, totalPrice);
          // Update custom price container
          const $priceDisplay = $form.find(
            ".woocommerce-Price-amount, .price .amount"
          );
          let $customPrice = $priceDisplay.siblings(
            ".intersoccer-custom-price"
          );
          if (!$customPrice.length) {
            $priceDisplay.after('<div class="intersoccer-custom-price"></div>');
            $customPrice = $priceDisplay.siblings(".intersoccer-custom-price");
          }
          $customPrice.html(`
            <span class="total-price">Total: CHF ${totalPrice.toFixed(2)} for ${
            selectedDays.length
          } day${selectedDays.length !== 1 ? "s" : ""}</span>
          `);
          console.log(
            "InterSoccer: Updated custom price container - Base:",
            variationPrice,
            "Total:",
            totalPrice,
            "Days:",
            selectedDays.length
          );

          const checkboxCount = $dayCheckboxes.find(
            'input[type="checkbox"]'
          ).length;
          console.log(
            "InterSoccer: Checkbox states after update:",
            $dayCheckboxes
              .find('input[type="checkbox"]')
              .map(function () {
                return $(this).val() + ":" + $(this).prop("disabled");
              })
              .get(),
            "Checkbox count:",
            checkboxCount
          );

          if (checkboxCount === 0) {
            console.warn("InterSoccer: Checkboxes missing, re-rendering");
            renderCheckboxes(
              days,
              $dayCheckboxes,
              $dayNotification,
              $errorMessage,
              variationPrice,
              playerId,
              variationId
            );
          }

          if (
            selectedDays.length === availableDays.length &&
            availableDays.length > 0
          ) {
            $dayNotification.text(
              "Youâ€™ve selected all days! Consider choosing the Full Week option for potential savings."
            );
          } else {
            $dayNotification.empty();
          }

          $form
            .find("button.single_add_to_cart_button")
            .prop("disabled", !(playerId && selectedDays.length > 0));
          console.log(
            "InterSoccer: Button state - Player:",
            playerId,
            "Days selected:",
            selectedDays.length
          );

          $dayCheckboxes.find('input[type="checkbox"]').prop("disabled", false);
        }, 100);

        isProcessing = false;
        isCheckboxUpdate = false;
      });
  }

  let variationTimeout;
  function handleVariation(variation, retryCount = 0, maxRetries = 3) {
    if (isProcessing || isCheckboxUpdate) return;
    isProcessing = true;

    console.log(
      "InterSoccer: found_variation triggered for variation ID:",
      variation?.variation_id
    );

    clearTimeout(variationTimeout);
    variationTimeout = setTimeout(() => {
      const bookingType =
        variation?.attributes?.attribute_pa_booking_type ||
        $form.find('select[name="attribute_pa_booking-type"]').val() ||
        "";
      const variationId = variation?.variation_id || 0;
      const variationPrice = variation?.display_price;
      if (!variationPrice) {
        console.error(
          "InterSoccer: No display_price for variation ID:",
          variationId
        );
        isProcessing = false;
        return;
      }
      console.log("InterSoccer: Variation price:", variationPrice);

      const $addToCartButton = $form.find("button.single_add_to_cart_button");
      const $priceDisplay = $form.find(
        ".woocommerce-Price-amount, .price .amount"
      );
      const $daySelection = $form.find(".intersoccer-day-selection");
      const $dayCheckboxes = $form.find(".intersoccer-day-checkboxes");
      const $dayNotification = $form.find(".intersoccer-day-notification");
      const $errorMessage = $form.find(
        ".intersoccer-day-selection .error-message"
      );

      // Clear any existing custom price container
      $priceDisplay.siblings(".intersoccer-custom-price").remove();

      $addToCartButton.prop("disabled", true);

      if (productType === "camp" && bookingType === "single-days") {
        if (!$daySelection.length && retryCount < maxRetries) {
          console.log(
            "InterSoccer: Day selection not found, retrying",
            retryCount + 1,
            "/",
            maxRetries
          );
          setTimeout(() => handleVariation(variation, retryCount + 1), 500);
          isProcessing = false;
          return;
        }
        $daySelection.show();
        console.log(
          "InterSoccer: Showing day selection row for Single Day(s) camp"
        );
        fetchDaysOfWeek(productId, variationId)
          .then((days) => {
            availableDays = days;
            console.log("InterSoccer: Rendering checkboxes for days:", days);
            const playerId = $form.find(".player-select").val();
            renderCheckboxes(
              days,
              $dayCheckboxes,
              $dayNotification,
              $errorMessage,
              variationPrice,
              playerId,
              variationId
            );
            currentVariationId = variationId;

            const quantity = 1;
            const totalPrice = selectedDays.length * variationPrice;
            // Custom price container added in renderCheckboxes
            console.log("InterSoccer: Initial price update to:", totalPrice);
            $addToCartButton.prop(
              "disabled",
              !(playerId && selectedDays.length > 0)
            );
          })
          .catch((error) => {
            console.error("InterSoccer: Failed to load days:", error);
            $daySelection.hide();
            $errorMessage.text("Failed to load days. Please try again.").show();
            setTimeout(() => $errorMessage.hide(), 5000);
          });
      } else {
        $daySelection.hide();
        selectedDays = [];
        currentVariationId = null;
        if (productType === "course") {
          fetchCourseMetadata(productId, variationId)
            .then((metadata) => {
              console.log(
                "InterSoccer: Fetched metadata for course:",
                metadata
              );
              let totalPrice = parseFloat(variationPrice);
              const serverTime = new Date(
                intersoccerCheckout.server_time || new Date()
              );
              let remainingWeeks = metadata.total_weeks;
              let originalPrice = totalPrice;
              let savings = 0;
              if (
                metadata.start_date &&
                serverTime > new Date(metadata.start_date)
              ) {
                const pricing = calculateProRatedPrice(
                  totalPrice,
                  metadata.start_date,
                  metadata.total_weeks,
                  metadata.weekly_discount
                );
                totalPrice = pricing.price;
                remainingWeeks = pricing.remainingWeeks;
                savings = originalPrice - totalPrice;
              }
              const playerId = $form.find(".player-select").val();
              updateFormData(playerId, [], totalPrice, remainingWeeks);
              // Add custom price container for discounted courses
              if (savings > 0 || totalPrice < originalPrice) {
                let $customPrice = $priceDisplay.siblings(
                  ".intersoccer-custom-price"
                );
                if (!$customPrice.length) {
                  $priceDisplay.after(
                    '<div class="intersoccer-custom-price"></div>'
                  );
                  $customPrice = $priceDisplay.siblings(
                    ".intersoccer-custom-price"
                  );
                }
                $customPrice.html(`
                  
                  <span class="discounted-price">Discounted: CHF ${totalPrice.toFixed(
                    2
                  )}</span>
                  <span class="savings">You saved CHF ${savings.toFixed(
                    2
                  )}</span>
                `);
                console.log(
                  "InterSoccer: Updated custom price container - Base:",
                  originalPrice,
                  "Discounted:",
                  totalPrice,
                  "Savings:",
                  savings
                );
              }
              console.log(
                "InterSoccer: Course price - Original:",
                originalPrice,
                "Discounted:",
                totalPrice,
                "Savings:",
                savings,
                "Remaining weeks:",
                remainingWeeks,
                "Player:",
                playerId
              );
              $addToCartButton.prop("disabled", !playerId);
            })
            .catch((error) => {
              console.error(
                "InterSoccer: Failed to fetch course metadata:",
                error
              );
              const playerId = $form.find(".player-select").val();
              updateFormData(playerId, [], variationPrice);
              console.log(
                "InterSoccer: Set price to:",
                variationPrice,
                "Player:",
                playerId
              );
              $addToCartButton.prop("disabled", !playerId);
            });
        } else if (variation && variationPrice) {
          const playerId = $form.find(".player-select").val();
          updateFormData(playerId, [], variationPrice);
          $form.find('input[name="quantity"]').val(1);
          console.log(
            "InterSoccer: Set price to:",
            variationPrice,
            "Player:",
            playerId
          );
          $addToCartButton.prop("disabled", !playerId);
        }
      }

      isProcessing = false;
    }, 100);
  }

  $form.on("found_variation", function (event, variation) {
    console.log("InterSoccer: found_variation event triggered");
    handleVariation(variation);
  });

  $form.find(".player-select").on("change", function () {
    const playerId = $(this).val();
    const bookingType = $form
      .find('select[name="attribute_pa_booking-type"]')
      .val();
    const selectedDaysCount = selectedDays.length;
    const $addToCartButton = $form.find("button.single_add_to_cart_button");

    const adjustedPrice = $form.find('input[name="adjusted_price"]').val();
    const remainingWeeks = $form.find('input[name="remaining_weeks"]').val();
    updateFormData(playerId, selectedDays, adjustedPrice, remainingWeeks);

    if (bookingType === "single-days") {
      $addToCartButton.prop("disabled", !(playerId && selectedDaysCount > 0));
      console.log(
        "InterSoccer: Player changed, button state - Player:",
        playerId,
        "Days selected:",
        selectedDaysCount
      );
    } else {
      $addToCartButton.prop("disabled", !playerId);
      console.log(
        "InterSoccer: Player changed, button state - Player:",
        playerId
      );
    }
  });

  $form.find("button.single_add_to_cart_button").on("click", function (e) {
    const $button = $(this);
    if ($button.hasClass("buy-now")) {
      console.log("InterSoccer: Buy Now button clicked");
      const playerId = $form.find(".player-select").val();
      const adjustedPrice = $form.find('input[name="adjusted_price"]').val();
      const remainingWeeks = $form.find('input[name="remaining_weeks"]').val();
      updateFormData(playerId, selectedDays, adjustedPrice, remainingWeeks);
      $form.append('<input type="hidden" name="buy_now" value="1">');
    }
  });

  $form.on("adding_to_cart", function (event, $button, data) {
    const playerId = $form.find(".player-select").val();
    const adjustedPrice = $form.find('input[name="adjusted_price"]').val();
    const remainingWeeks = $form.find('input[name="remaining_weeks"]').val();
    if (playerId) data.player_assignment = playerId;
    if (selectedDays.length) data.camp_days = selectedDays;
    if (adjustedPrice) data.custom_price = adjustedPrice;
    if (remainingWeeks) data.remaining_weeks = remainingWeeks;
    console.log(
      "InterSoccer: Adding to cart with player:",
      playerId,
      "days:",
      selectedDays,
      "adjusted price:",
      adjustedPrice,
      "remaining weeks:",
      remainingWeeks
    );
  });

  $form.trigger("check_variations");
  console.log("InterSoccer: Triggered check_variations on form load");
});
