/**
 * File: player-management.js
 * Description: Manages the player management table on the WooCommerce My Account page at /my-account/manage-players/. Displays players in a spreadsheet-like table with a hidden 'Add Attendee' section toggled by an 'Add' button. New players span two rows. Uses Day/Month/Year dropdowns, fixes duplicate rows with stricter DOM control, ensures multiple Adds, maintains input field position, Medical Conditions on Delete.
 * Dependencies: jQuery (checked)
 * Changes:
 * - Fixed duplicate rows by detaching $newRow and reordering before insertion (2025-05-18).
 * - Added post-insertion duplicate check for data-player-index (2025-05-18).
 * - Fixed duplicate rows with isAdding flag and enhanced duplicate check (2025-05-18).
 * - Enhanced debouncing for .player-submit clicks (2025-05-18).
 * - Fixed duplicate rows with player data check and unique index (2025-05-18).
 * - Fixed multiple player adds by using on() instead of one() (2025-05-18).
 * - Fixed Add Attendee field position by reordering .add-player-section (2025-05-18).
 * - Fixed Medical Conditions row remaining after Delete (2025-05-18).
 * - Fixed syntax error in $newRow template literal (2025-05-18).
 * - Ensured Gender/DOB editable within Grace Period (1 year) (2025-05-18).
 * - Ensured Medical Conditions editable with full-row width (2025-05-18).
 * - Fixed blank First Name/Last Name on Cancel (2025-05-18).
 * Testing:
 * - Verify Add creates single row, multiple Adds work, Add Attendee field at table end, Edit allows Gender/DOB within Grace Period, Medical Conditions editable and full-width, Delete removes player and Medical Conditions, Cancel restores all fields.
 * - Test Add/Edit/Delete with any user role, no errors.
 * - Confirm no duplicate players or 403 errors.
 */

(function ($) {
  // Dependency checks
  if (typeof $ === "undefined") {
    console.error(
      "InterSoccer: jQuery is not loaded. Player management disabled."
    );
    return;
  }
  if (
    !window.intersoccerPlayer ||
    !intersoccerPlayer.ajax_url ||
    !intersoccerPlayer.nonce
  ) {
    console.error(
      "InterSoccer: intersoccerPlayer data not initialized. Player management disabled."
    );
    return;
  }

  // Check for container
  const $container = $(".intersoccer-player-management");
  if (!$container.length) {
    console.error(
      "InterSoccer: Player management container (.intersoccer-player-management) not found."
    );
    return;
  }

  const $table = $("#player-table");
  const $message = $container.find(".intersoccer-message");
  let isProcessing = false;
  let isAdding = false;
  let editingIndex = null;
  let nonceRetryAttempted = false;
  let lastClickTime = 0;
  const clickDebounceMs = 300;

  // Log user role for debugging
  $.ajax({
    url: intersoccerPlayer.ajax_url,
    type: "POST",
    data: { action: "intersoccer_get_user_role" },
    success: (response) => {
      console.log(
        "InterSoccer: User role:",
        response.data?.role,
        "User ID:",
        intersoccerPlayer.user_id
      );
    },
    error: (xhr) => {
      console.error(
        "InterSoccer: Failed to fetch user role:",
        xhr.status,
        xhr.responseText
      );
    },
  });

  // Toggle Add Attendee section
  $container.on("click", ".toggle-add-player", function (e) {
    e.preventDefault();
    console.log("InterSoccer: Toggle Add Player clicked");
    const $section = $(".add-player-section");
    const isVisible = $section.hasClass("active");
    $section.toggleClass("active", !isVisible);
    $(this).attr("aria-expanded", !isVisible);
    if (!isVisible) {
      $("#player_first_name").focus();
    } else {
      $(
        ".add-player-section input, .add-player-section select, .add-player-section textarea"
      ).val("");
      $(".add-player-section .error-message").hide();
    }
  });

  // Cancel Add
  $container.on("click", ".cancel-add", function (e) {
    e.preventDefault();
    console.log("InterSoccer: Cancel Add clicked");
    $(".add-player-section").removeClass("active");
    $(".toggle-add-player").attr("aria-expanded", "false").focus();
    $(
      ".add-player-section input, .add-player-section select, .add-player-section textarea"
    ).val("");
    $(".add-player-section .error-message").hide();
  });

  // Validation
  function validateRow($row, isAdd = false) {
    console.log("InterSoccer: Validating row, isAdd:", isAdd);
    let isValid = true;
    $row.find(".error-message").hide();
    const $medicalRow = isAdd
      ? $row.next(".add-player-medical")
      : $row.next(".medical-row");

    const $firstName = $row.find('[name="player_first_name"]');
    const $lastName = $row.find('[name="player_last_name"]');
    const $dobDay = $row.find('[name="player_dob_day"]');
    const $dobMonth = $row.find('[name="player_dob_month"]');
    const $dobYear = $row.find('[name="player_dob_year"]');
    const $gender = $row.find('[name="player_gender"]');
    const $medical = isAdd
      ? $medicalRow.find('[name="player_medical"]')
      : $medicalRow.find('[name="player_medical"]');

    console.log("InterSoccer: Input elements found:", {
      firstName: $firstName.length,
      lastName: $lastName.length,
      dobDay: $dobDay.length,
      dobMonth: $dobMonth.length,
      dobYear: $dobYear.length,
      gender: $gender.length,
      medical: $medical.length,
    });

    const firstName = $firstName.val().trim();
    const lastName = $lastName.val().trim();
    const dobDay = $dobDay.val();
    const dobMonth = $dobMonth.val();
    const dobYear = $dobYear.val();
    const gender = $gender.val();
    const medical = $medical.length ? $medical.val().trim() : "";

    console.log("InterSoccer: Validation input:", {
      firstName,
      lastName,
      dobDay,
      dobMonth,
      dobYear,
      gender,
      medical,
    });

    if (
      !firstName ||
      firstName.length > 50 ||
      !/^[a-zA-Z\s\-\p{L}]+$/.test(firstName)
    ) {
      $firstName
        .next(".error-message")
        .text("Valid first name required (max 50 chars, letters only).")
        .show();
      console.log("InterSoccer: First name validation failed:", firstName);
      isValid = false;
    }
    if (
      !lastName ||
      lastName.length > 50 ||
      !/^[a-zA-Z\s\-\p{L}]+$/.test(lastName)
    ) {
      $lastName
        .next(".error-message")
        .text("Valid last name required (max 50 chars, letters only).")
        .show();
      console.log("InterSoccer: Last name validation failed:", lastName);
      isValid = false;
    }
    // Only validate DOB if provided (for Edit outside Grace Period)
    if (dobDay && dobMonth && dobYear) {
      const dob = `${dobYear}-${dobMonth}-${dobDay}`;
      const dobDate = new Date(dob);
      const today = new Date("2025-05-18");
      if (isNaN(dobDate.getTime()) || dobDate > today) {
        $dobDay.next(".error-message").text("Invalid date of birth.").show();
        console.log("InterSoccer: Invalid DOB:", dob);
        isValid = false;
      } else {
        const age =
          today.getFullYear() -
          dobDate.getFullYear() -
          (today.getMonth() < dobDate.getMonth() ||
          (today.getMonth() === dobDate.getMonth() &&
            today.getDate() < dobDate.getDate())
            ? 1
            : 0);
        console.log("InterSoccer: Calculated age:", age);
        if (age < 2 || age > 13) {
          $dobDay
            .next(".error-message")
            .text("Player must be 2-13 years old.")
            .show();
          console.log("InterSoccer: Age out of range:", age);
          isValid = false;
        }
      }
    }
    if (gender && !["male", "female", "other"].includes(gender)) {
      $gender.next(".error-message").text("Invalid gender selection.").show();
      console.log("InterSoccer: Invalid gender:", gender);
      isValid = false;
    }
    if (medical.length > 500) {
      $medical
        .next(".error-message")
        .text("Medical conditions must be under 500 chars.")
        .show();
      console.log("InterSoccer: Medical conditions too long:", medical.length);
      isValid = false;
    }

    console.log("InterSoccer: Row validation result:", isValid);
    return isValid;
  }

  // Refresh nonce (one retry)
  function refreshNonce() {
    console.log("InterSoccer: Refreshing nonce");
    return new Promise((resolve, reject) => {
      $.ajax({
        url: intersoccerPlayer.nonce_refresh_url,
        type: "POST",
        data: { action: "intersoccer_refresh_nonce" },
        success: (response) => {
          if (response.success && response.data.nonce) {
            intersoccerPlayer.nonce = response.data.nonce;
            console.log(
              "InterSoccer: Nonce refreshed:",
              intersoccerPlayer.nonce
            );
            resolve();
          } else {
            console.error("InterSoccer: Nonce refresh failed:", response);
            reject(
              new Error(
                "Nonce refresh failed: " +
                  (response.data?.message || "Unknown error")
              )
            );
          }
        },
        error: (xhr) => {
          console.error(
            "InterSoccer: Nonce refresh error:",
            xhr.status,
            xhr.responseText
          );
          reject(new Error("Nonce refresh error: " + xhr.statusText));
        },
      });
    });
  }

  // Save player (add or edit)
  function savePlayer($row, isAdd = false) {
    console.log("InterSoccer: savePlayer called, isAdd:", isAdd);
    if (isProcessing) {
      console.log("InterSoccer: Processing, ignoring save");
      return;
    }
    if (isAdd && isAdding) {
      console.log(
        "InterSoccer: Already adding a player, ignoring duplicate save"
      );
      return;
    }
    if (!validateRow($row, isAdd)) {
      console.log("InterSoccer: Validation failed");
      return;
    }

    isProcessing = true;
    if (isAdd) {
      isAdding = true;
      console.log("InterSoccer: Setting isAdding flag to true");
    }
    const $submitLink = $row.find(".player-submit");
    $submitLink
      .addClass("disabled")
      .attr("aria-disabled", "true")
      .find(".spinner")
      .show();

    const index = isAdd ? "-1" : $row.data("player-index");
    const $medicalRow = isAdd
      ? $row.next(".add-player-medical")
      : $row.next(".medical-row");
    const firstName = $row.find('[name="player_first_name"]').val().trim();
    const lastName = $row.find('[name="player_last_name"]').val().trim();
    const dobDay = $row.find('[name="player_dob_day"]').val();
    const dobMonth = $row.find('[name="player_dob_month"]').val();
    const dobYear = $row.find('[name="player_dob_year"]').val();
    const dob =
      dobDay && dobMonth && dobYear ? `${dobYear}-${dobMonth}-${dobDay}` : "";
    const gender = $row.find('[name="player_gender"]').val();
    const medical = (
      $medicalRow.length
        ? $medicalRow.find('[name="player_medical"]').val()
        : ""
    ).trim();

    const action = isAdd ? "intersoccer_add_player" : "intersoccer_edit_player";
    const data = {
      action: action,
      nonce: intersoccerPlayer.nonce,
      user_id: intersoccerPlayer.user_id,
      player_first_name: firstName,
      player_last_name: lastName,
      player_dob: dob,
      player_gender: gender,
      player_medical: medical,
    };
    if (!isAdd) {
      data.player_index = index;
    }

    console.log(
      "InterSoccer: Sending AJAX request:",
      action,
      "Nonce:",
      intersoccerPlayer.nonce,
      "Data:",
      data
    );

    $.ajax({
      url: intersoccerPlayer.ajax_url,
      type: "POST",
      data: data,
      success: (response) => {
        console.log("InterSoccer: AJAX success:", response);
        if (response.success) {
          $message.text(response.data.message).show();
          setTimeout(() => $message.hide(), 10000);
          const player = response.data.player;

          if (isAdd) {
            // Add new row (single row after save)
            $table.find(".no-players").remove();
            const newIndex = $table.find("tr[data-player-index]").length;
            // Remove any existing row with the same index to prevent duplicates
            $table.find(`tr[data-player-index="${newIndex}"]`).remove();
            // Check for existing player data to prevent duplicates
            const existingPlayer = $table
              .find("tr[data-player-index]")
              .filter(function () {
                return (
                  $(this).find(".display-first-name").text() ===
                    player.first_name &&
                  $(this).find(".display-last-name").text() ===
                    player.last_name &&
                  $(this).find(".display-dob").text() === player.dob
                );
              });
            if (existingPlayer.length) {
              console.log(
                "InterSoccer: Duplicate player data detected, removing and re-adding:",
                player.first_name,
                player.last_name
              );
              existingPlayer.remove();
            }
            console.log(
              "InterSoccer: DOM state before insertion, row count:",
              $table.find("tr[data-player-index]").length
            );
            const $newRow = $(`
                          <tr data-player-index="${newIndex}" 
                              data-first-name="${player.first_name || "N/A"}" 
                              data-last-name="${player.last_name || "N/A"}" 
                              data-dob="${player.dob || "N/A"}" 
                              data-gender="${player.gender || "N/A"}" 
                              data-creation-timestamp="${
                                player.creation_timestamp || ""
                              }">
                              <td class="display-first-name">${
                                player.first_name || "N/A"
                              }</td>
                              <td class="display-last-name">${
                                player.last_name || "N/A"
                              }</td>
                              <td class="display-dob">${
                                player.dob || "N/A"
                              }</td>
                              <td class="display-gender">${
                                player.gender || "N/A"
                              }</td>
                              <td class="actions">
                                  <a href="#" class="edit-player" data-index="${newIndex}" aria-label="Edit player ${
              player.first_name || ""
            }" aria-expanded="false">
                                      Edit
                                  </a>
                              </td>
                          </tr>
                      `);
            // Reorder .add-player-section and .add-player-medical to table end *before* insertion
            $table.append($table.find(".add-player-section"));
            $table.append($table.find(".add-player-medical"));
            console.log(
              "InterSoccer: Reordered .add-player-section and .add-player-medical to table end"
            );
            // Insert $newRow and detach to prevent reuse
            console.log("InterSoccer: Adding new player row, index:", newIndex);
            $table.find(".add-player-section").before($newRow);
            $newRow
              .detach()
              .appendTo(
                $table
                  .find(".add-player-section")
                  .parent()
                  .children()
                  .eq(newIndex)
              );
            console.log(
              "InterSoccer: $newRow appended and detached, index:",
              newIndex
            );
            // Final check for duplicates by data-player-index
            const rowsWithIndex = $table.find(
              `tr[data-player-index="${newIndex}"]`
            );
            if (rowsWithIndex.length > 1) {
              console.log(
                "InterSoccer: Duplicate data-player-index detected post-insertion, removing extra:",
                newIndex
              );
              rowsWithIndex.slice(1).remove();
            }
            console.log(
              "InterSoccer: DOM state after insertion, row count:",
              $table.find("tr[data-player-index]").length
            );
            $(".add-player-section").removeClass("active");
            $(".toggle-add-player").attr("aria-expanded", "false");
            $(
              ".add-player-section input, .add-player-section select, .add-player-section textarea"
            ).val("");
            $(".add-player-section .error-message").hide();
          } else {
            // Update existing row
            console.log("InterSoccer: Updating player row, index:", index);
            $row.attr("data-first-name", player.first_name || "N/A");
            $row.attr("data-last-name", player.last_name || "N/A");
            $row.attr("data-dob", player.dob || "N/A");
            $row.attr("data-gender", player.gender || "N/A");
            $row.attr(
              "data-creation-timestamp",
              player.creation_timestamp || ""
            );
            $row.find(".display-first-name").text(player.first_name || "N/A");
            $row.find(".display-last-name").text(player.last_name || "N/A");
            $row.find(".display-dob").text(player.dob || "N/A");
            $row.find(".display-gender").text(player.gender || "N/A");
            $row.find(".actions").html(`
                          <a href="#" class="edit-player" data-index="${index}" aria-label="Edit player ${
              player.first_name || ""
            }" aria-expanded="false">
                              Edit
                          </a>
                      `);
            $medicalRow.remove();
            editingIndex = null;
            $table
              .find(".edit-player")
              .removeClass("disabled")
              .attr("aria-disabled", "false");
          }
        } else {
          console.error(
            "InterSoccer: AJAX response failure:",
            response.data?.message
          );
          $message
            .text(response.data.message || "Failed to save player.")
            .show();
          setTimeout(() => $message.hide(), 10000);
        }
      },
      error: (xhr) => {
        console.error(
          "InterSoccer: AJAX error:",
          xhr.status,
          "Response:",
          xhr.responseText
        );
        if (xhr.status === 403 && !nonceRetryAttempted) {
          console.log(
            "InterSoccer: 403 error, attempting nonce refresh (once)"
          );
          nonceRetryAttempted = true;
          refreshNonce()
            .then(() => {
              console.log(
                "InterSoccer: Retrying AJAX with new nonce:",
                intersoccerPlayer.nonce
              );
              data.nonce = intersoccerPlayer.nonce;
              $.ajax(this);
            })
            .catch((error) => {
              console.error("InterSoccer: Nonce refresh failed:", error);
              $message.text("Error: Failed to refresh security token.").show();
              setTimeout(() => $message.hide(), 10000);
              nonceRetryAttempted = false;
            });
        } else {
          console.error(
            "InterSoccer: Non-403 AJAX error:",
            xhr.status,
            xhr.responseText
          );
          $message
            .text(
              "Error: Unable to save player - " +
                (xhr.responseText || "Unknown error")
            )
            .show();
          setTimeout(() => $message.hide(), 10000);
          nonceRetryAttempted = false;
        }
      },
      complete: () => {
        console.log("InterSoccer: AJAX complete");
        isProcessing = false;
        if (isAdd) {
          isAdding = false;
          console.log("InterSoccer: Resetting isAdding flag to false");
        }
        $submitLink
          .removeClass("disabled")
          .attr("aria-disabled", "false")
          .find(".spinner")
          .hide();
      },
    });
  }

  // Save player (edit or add) with debounce
  $container.on("click", ".player-submit", function (e) {
    e.preventDefault();
    const currentTime = Date.now();
    if (currentTime - lastClickTime < clickDebounceMs) {
      console.log("InterSoccer: Save Player click debounced, ignoring");
      return;
    }
    lastClickTime = currentTime;
    console.log("InterSoccer: Save Player binding checked");
    if ($(this).hasClass("disabled")) {
      console.log("InterSoccer: Save button disabled, ignoring click");
      return;
    }
    const $row = $(this).closest("tr");
    const isAdd = $row.hasClass("add-player-section");
    console.log("InterSoccer: Save Player clicked, isAdd:", isAdd);
    savePlayer($row, isAdd);
  });

  // Edit player
  $container.on("click", ".edit-player", function (e) {
    e.preventDefault();
    console.log("InterSoccer: Edit Player binding checked");
    if (isProcessing || editingIndex !== null) {
      console.log(
        "InterSoccer: Edit ignored, processing or another row being edited"
      );
      return;
    }

    const index = $(this).data("index");
    console.log("InterSoccer: Edit Player clicked, index:", index);
    editingIndex = index;

    const $row = $table.find(`tr[data-player-index="${index}"]`);
    const firstName =
      $row.attr("data-first-name") ||
      $row.find(".display-first-name").text() ||
      "N/A";
    const lastName =
      $row.attr("data-last-name") ||
      $row.find(".display-last-name").text() ||
      "N/A";
    const dob =
      $row.attr("data-dob") || $row.find(".display-dob").text() || "N/A";
    const dobParts = dob !== "N/A" ? dob.split("-") : ["", "", ""];
    const dobYear = dobParts[0];
    const dobMonth = dobParts[1];
    const dobDay = dobParts[2];
    const gender =
      $row.attr("data-gender") || $row.find(".display-gender").text() || "N/A";
    const medical =
      ($row.next(".medical-row").find('[name="player_medical"]').length
        ? $row.next(".medical-row").find('[name="player_medical"]').val()
        : "") || "";
    const creationTimestamp = $row.attr("data-creation-timestamp") || "";
    const gracePeriodDays = 365; // 1 year
    const currentTimestamp = Math.floor(Date.now() / 1000);
    const isWithinGracePeriod =
      creationTimestamp &&
      currentTimestamp - parseInt(creationTimestamp) <
        gracePeriodDays * 24 * 60 * 60;

    console.log(
      "InterSoccer: Rendering Edit row, index:",
      index,
      "FirstName:",
      firstName,
      "LastName:",
      lastName,
      "DOB:",
      dob,
      "Gender:",
      gender,
      "Medical:",
      medical,
      "WithinGracePeriod:",
      isWithinGracePeriod
    );

    $row.find("td").eq(0).html(`
          <input type="text" name="player_first_name" value="${
            firstName === "N/A" ? "" : firstName
          }" required aria-required="true" maxlength="50">
          <span class="error-message" style="display: none;"></span>
      `);
    $row.find("td").eq(1).html(`
          <input type="text" name="player_last_name" value="${
            lastName === "N/A" ? "" : lastName
          }" required aria-required="true" maxlength="50">
          <span class="error-message" style="display: none;"></span>
      `);
    $row
      .find("td")
      .eq(2)
      .html(
        isWithinGracePeriod
          ? `
          <select name="player_dob_day" required aria-required="true">
              <option value="">Day</option>
              ${Array.from({ length: 31 }, (_, i) => i + 1)
                .map(
                  (day) =>
                    `<option value="${String(day).padStart(2, "0")}" ${
                      dobDay === String(day).padStart(2, "0") ? "selected" : ""
                    }>${day}</option>`
                )
                .join("")}
          </select>
          <select name="player_dob_month" required aria-required="true">
              <option value="">Month</option>
              <option value="01" ${
                dobMonth === "01" ? "selected" : ""
              }>January</option>
              <option value="02" ${
                dobMonth === "02" ? "selected" : ""
              }>February</option>
              <option value="03" ${
                dobMonth === "03" ? "selected" : ""
              }>March</option>
              <option value="04" ${
                dobMonth === "04" ? "selected" : ""
              }>April</option>
              <option value="05" ${
                dobMonth === "05" ? "selected" : ""
              }>May</option>
              <option value="06" ${
                dobMonth === "06" ? "selected" : ""
              }>June</option>
              <option value="07" ${
                dobMonth === "07" ? "selected" : ""
              }>July</option>
              <option value="08" ${
                dobMonth === "08" ? "selected" : ""
              }>August</option>
              <option value="09" ${
                dobMonth === "09" ? "selected" : ""
              }>September</option>
              <option value="10" ${
                dobMonth === "10" ? "selected" : ""
              }>October</option>
              <option value="11" ${
                dobMonth === "11" ? "selected" : ""
              }>November</option>
              <option value="12" ${
                dobMonth === "12" ? "selected" : ""
              }>December</option>
          </select>
          <select name="player_dob_year" required aria-required="true">
              <option value="">Year</option>
              ${Array.from({ length: 2023 - 2012 + 1 }, (_, i) => 2023 - i)
                .map(
                  (year) =>
                    `<option value="${year}" ${
                      dobYear === String(year) ? "selected" : ""
                    }>${year}</option>`
                )
                .join("")}
          </select>
          <span class="error-message" style="display: none;"></span>
      `
          : `
          <span class="display-dob">${dob}</span>
      `
      );
    $row
      .find("td")
      .eq(3)
      .html(
        isWithinGracePeriod
          ? `
          <select name="player_gender" required aria-required="true">
              <option value="">Select Gender</option>
              <option value="male" ${
                gender === "male" ? "selected" : ""
              }>Male</option>
              <option value="female" ${
                gender === "female" ? "selected" : ""
              }>Female</option>
              <option value="other" ${
                gender === "other" ? "selected" : ""
              }>Other</option>
          </select>
          <span class="error-message" style="display: none;"></span>
      `
          : `
          <span class="display-gender">${gender}</span>
      `
      );
    $row.find(".actions").html(`
          <a href="#" class="player-submit" aria-label="Save Player">Save</a> /
          <a href="#" class="cancel-edit" aria-label="Cancel Edit">Cancel</a> /
          <a href="#" class="delete-player" aria-label="Delete player ${
            firstName || ""
          }">Delete</a>
      `);

    // Insert hidden Medical Conditions row
    const $medicalRow = $(`
          <tr class="medical-row active" data-player-index="${index}">
              <td colspan="5">
                  <label for="player_medical_${index}">Medical Conditions:</label>
                  <textarea id="player_medical_${index}" name="player_medical" maxlength="500" aria-describedby="medical-instructions-${index}">${medical}</textarea>
                  <span id="medical-instructions-${index}" class="screen-reader-text">Optional field for medical conditions.</span>
                  <span class="error-message" style="display: none;"></span>
              </td>
          </tr>
      `);
    console.log("InterSoccer: Adding medical row for Edit, index:", index);
    $row.after($medicalRow);

    $table
      .find(".edit-player")
      .not(this)
      .addClass("disabled")
      .attr("aria-disabled", "true");
    $(this).attr("aria-expanded", "true");
  });

  // Cancel edit
  $container.on("click", ".cancel-edit", function (e) {
    e.preventDefault();
    console.log("InterSoccer: Cancel Edit binding checked");
    const $row = $(this).closest("tr");
    const index = $row.data("player-index");

    const firstName = $row.attr("data-first-name") || "N/A";
    const lastName = $row.attr("data-last-name") || "N/A";
    const dob = $row.attr("data-dob") || "N/A";
    const gender = $row.attr("data-gender") || "N/A";

    console.log(
      "InterSoccer: Restoring row on Cancel, index:",
      index,
      "FirstName:",
      firstName,
      "LastName:",
      lastName,
      "DOB:",
      dob,
      "Gender:",
      gender
    );

    // Fallback to AJAX if data attributes are missing
    if (
      firstName === "N/A" ||
      lastName === "N/A" ||
      dob === "N/A" ||
      gender === "N/A"
    ) {
      console.log("InterSoccer: Data attributes missing, fetching from server");
      $.ajax({
        url: intersoccerPlayer.ajax_url,
        type: "POST",
        data: {
          action: "intersoccer_get_player",
          nonce: intersoccerPlayer.nonce,
          user_id: intersoccerPlayer.user_id,
          player_index: index,
        },
        success: (response) => {
          if (response.success && response.data.player) {
            const player = response.data.player;
            console.log("InterSoccer: Fetched player data:", player);
            $row.attr("data-first-name", player.first_name || "N/A");
            $row.attr("data-last-name", player.last_name || "N/A");
            $row.attr("data-dob", player.dob || "N/A");
            $row.attr("data-gender", player.gender || "N/A");
            $row.attr(
              "data-creation-timestamp",
              player.creation_timestamp || ""
            );
            $row.find(".display-first-name").text(player.first_name || "N/A");
            $row.find(".display-last-name").text(player.last_name || "N/A");
            $row.find(".display-dob").text(player.dob || "N/A");
            $row.find(".display-gender").text(player.gender || "N/A");
          } else {
            console.error(
              "InterSoccer: Failed to fetch player data:",
              response.data?.message
            );
          }
        },
        error: (xhr) => {
          console.error(
            "InterSoccer: Error fetching player data:",
            xhr.status,
            xhr.responseText
          );
        },
      });
    }

    $row
      .find("td")
      .eq(0)
      .html(`<span class="display-first-name">${firstName}</span>`);
    $row
      .find("td")
      .eq(1)
      .html(`<span class="display-last-name">${lastName}</span>`);
    $row.find("td").eq(2).html(`<span class="display-dob">${dob}</span>`);
    $row.find("td").eq(3).html(`<span class="display-gender">${gender}</span>`);
    $row.find(".actions").html(`
          <a href="#" class="edit-player" data-index="${index}" aria-label="Edit player ${firstName || ""}" aria-expanded="false">
              Edit
          </a>
      `);
    $row.next(".medical-row").remove();

    editingIndex = null;
    $table
      .find(".edit-player")
      .removeClass("disabled")
      .attr("aria-disabled", "false");
  });

  // Delete player
  $container.on("click", ".delete-player", function (e) {
    e.preventDefault();
    console.log("InterSoccer: Delete Player binding checked");
    if (isProcessing) {
      console.log("InterSoccer: Processing, ignoring click");
      return;
    }
    const $row = $(this).closest("tr");
    const index = $row.data("player-index");
    if (!confirm("Are you sure you want to delete this player?")) {
      return;
    }

    isProcessing = true;
    $.ajax({
      url: intersoccerPlayer.ajax_url,
      type: "POST",
      data: {
        action: "intersoccer_delete_player",
        nonce: intersoccerPlayer.nonce,
        user_id: intersoccerPlayer.user_id,
        player_index: index,
      },
      success: (response) => {
        console.log("InterSoccer: Delete AJAX success:", response);
        if (response.success) {
          $message.text(response.data.message).show();
          setTimeout(() => $message.hide(), 10000);
          $row.remove();
          const $medicalRow = $table.find(
            `tr.medical-row[data-player-index="${index}"]`
          );
          if ($medicalRow.length) {
            console.log(
              "InterSoccer: Removing medical row for player index:",
              index
            );
            $medicalRow.remove();
          } else {
            console.log(
              "InterSoccer: No medical row found for player index:",
              index
            );
          }
          if (!$table.find("tr[data-player-index]").length) {
            $table.find(".no-players").remove();
            $table
              .find(".add-player-section")
              .before(
                '<tr class="no-players"><td colspan="5">No attendees added yet.</td></tr>'
              );
          }
          editingIndex = null;
          $table
            .find(".edit-player")
            .removeClass("disabled")
            .attr("aria-disabled", "false");
        } else {
          console.error(
            "InterSoccer: Delete AJAX response failure:",
            response.data?.message
          );
          $message
            .text(response.data.message || "Failed to delete player.")
            .show();
          setTimeout(() => $message.hide(), 10000);
        }
      },
      error: (xhr) => {
        console.error(
          "InterSoccer: Delete AJAX error:",
          xhr.status,
          xhr.responseText
        );
        if (xhr.status === 403 && !nonceRetryAttempted) {
          console.log(
            "InterSoccer: 403 error, attempting nonce refresh (once)"
          );
          nonceRetryAttempted = true;
          refreshNonce()
            .then(() => {
              console.log(
                "InterSoccer: Retrying AJAX with new nonce:",
                intersoccerPlayer.nonce
              );
              data.nonce = intersoccerPlayer.nonce;
              $.ajax(this);
            })
            .catch((error) => {
              console.error("InterSoccer: Nonce refresh failed:", error);
              $message.text("Error: Failed to refresh security token.").show();
              setTimeout(() => $message.hide(), 10000);
              nonceRetryAttempted = false;
            });
        } else {
          console.error(
            "InterSoccer: Non-403 AJAX error:",
            xhr.status,
            xhr.responseText
          );
          $message
            .text(
              "Error: Unable to delete player - " +
                (xhr.responseText || "Unknown error")
            )
            .show();
          setTimeout(() => $message.hide(), 10000);
          nonceRetryAttempted = false;
        }
      },
      complete: () => {
        console.log("InterSoccer: Delete AJAX complete");
        isProcessing = false;
        nonceRetryAttempted = false;
      },
    });
  });

  console.log("InterSoccer: player-management.js fully loaded");
})(jQuery);
